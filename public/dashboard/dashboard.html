<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="shortcut icon" href="../assets/icon/favicon2.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mugiwara's Journal - Votação de Personagens</title>

    <link rel="stylesheet" href="./../css/dashboards.css">
    <link rel="stylesheet" href="./../css/estilo.css" />
    <script src="../js/sessao.js"></script>
    <script src="./../js/alerta.js"></script>

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://kit.fontawesome.com/9f7414eb10.js" crossorigin="anonymous"></script>
</head>

<body>
    <div class="janela">
        <div class="header-left">
            <h1>Mugiwara's Journal</h1>
            <div class="hello">
                <h3>Olá, <span id="b_usuario">usuário</span>!</h3>
            </div>

            <div class="btn-nav">
                <h3>Votação de Personagens</h3>
            </div>

            <div class="btn-logout" onclick="limparSessao()">
                <h3>Sair</h3>
            </div>
        </div>

        <div class="dash">
            <div id="alerta"></div>

            <div class="votacao">
                <h2>Vote no seu Personagem Favorito de One Piece</h2>
                <div id="personagens" class="personagens-container">
                    <!-- Os personagens serão listados aqui -->
                </div>
            </div>

            <div id="graficos">
                <h2>Resultados de Votação</h2>
                <canvas id="resultadoVotos"></canvas>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('b_usuario').innerHTML = sessionStorage.NOME_USUARIO;

        // Função para buscar personagens e votos do banco de dados
        async function carregarPersonagens() {
            try {
                const response = await fetch('/personagens/votos', { cache: 'no-store' });
                const personagens = await response.json();

                const personagensContainer = document.getElementById('personagens');
                personagensContainer.innerHTML = '';

                personagens.forEach(personagem => {
                    personagensContainer.innerHTML += `
                        <div class="personagem-card">
                            <h3>${personagem.nome}</h3>
                            <p>${personagem.descricao}</p>
                            <p>Votos: <span id="votos-${personagem.idPersonagem}">${personagem.votos}</span></p>
                            <button onclick="votar(${personagem.idPersonagem})">Votar</button>
                        </div>
                    `;
                });

                plotarGrafico(personagens);
            } catch (error) {
                console.error('Erro ao carregar personagens:', error);
            }
        }

        async function votar(idPersonagem) {
            try {
                const response = await fetch(`/votar/${idPersonagem}`, { method: 'POST' });
                if (response.ok) {
                    const votosElemento = document.getElementById(`votos-${idPersonagem}`);
                    votosElemento.innerText = parseInt(votosElemento.innerText) + 1;
                    carregarPersonagens(); 
                } else {
                    console.error('Erro ao votar:', response.statusText);
                }
            } catch (error) {
                console.error('Erro ao votar:', error);
            }
        }

        function plotarGrafico(personagens) {
            const labels = personagens.map(personagem => personagem.nome);
            const dataVotos = personagens.map(personagem => personagem.votos);

            const data = {
                labels: labels,
                datasets: [{
                    label: 'Votos',
                    data: dataVotos,
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            };

            const config = {
                type: 'bar',
                data: data,
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            };

            const ctx = document.getElementById('resultadoVotos').getContext('2d');
            new Chart(ctx, config);
        }

        carregarPersonagens();
    </script>
</body>

</html>
